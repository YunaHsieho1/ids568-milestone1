# Milestone 2：Google Artifact Registry 與 CI/CD 詳細設定說明

依序完成以下步驟，即可讓 GitHub Actions 自動建置映像並推送到你的 Google Artifact Registry。

---

## 前置確認（你已具備）

從你的 IAM 畫面可知：

- 專案：**milestone1-tzuyu**
- 服務帳戶 **artifact-registry-push** 已具備 **Artifact Registry Writer** 角色（專案層級），可推送映像，無需再改 IAM。

接下來只需：建立 Artifact Registry 倉庫 → 下載金鑰 → 在 GitHub 設定 Secret → 打 tag 觸發推送。

---

## 步驟一：在 GCP 建立 Artifact Registry 倉庫（若尚未建立）

1. 開啟 [Google Cloud Console](https://console.cloud.google.com/)。
2. 左上角確認專案為 **milestone1-tzuyu**。
3. 左側選單或搜尋列輸入 **Artifact Registry**，進入 **Artifact Registry**。
4. 點 **+ 建立存放區**（Create repository）。
5. 填寫：
   - **名稱**：`docker`（或你自訂名稱；若不同，需在 workflow 裡改 `GAR_REPOSITORY`）。
   - **格式**：選 **Docker**。
   - **模式**：選 **標準**（Standard）。
   - **位置類型**：選 **區域**（Region）。
   - **區域**：選 **us-central1**（若選其他區域，需在 workflow 裡改 `GAR_REGION`）。
6. 點 **建立**。

完成後會看到一個 Docker 格式的倉庫，例如：`us-central1-docker.pkg.dev/milestone1-tzuyu/docker`。

---

## 步驟二：為服務帳戶建立 JSON 金鑰

1. 在 GCP 左側選單進入 **IAM 與管理** → **服務帳戶**（或搜尋 **Service accounts**）。
2. 在清單中找到 **artifact-registry-push**，點進去。
3. 上方切到 **金鑰**（Keys）分頁。
4. 點 **新增金鑰**（Add key）→ **建立新金鑰**（Create new key）。
5. 選 **JSON**，點 **建立**。瀏覽器會下載一個 `.json` 檔案（檔名類似 `milestone1-tzuyu-xxxxx.json`）。
6. **重要**：此檔案等同密碼，請勿上傳到 Git 或分享。只用於下一步貼到 GitHub Secret。

---

## 步驟三：在 GitHub 新增 Secret（GCP_SA_KEY）

1. 開啟你的 **GitHub 倉庫**（放 `ids568-milestone1` 的那個 repo）。
2. 點上方 **Settings**（設定）。
3. 左側 **Secrets and variables** → **Actions**。
4. 點 **New repository secret**（新增儲存庫密碼）。
5. 填寫：
   - **Name**：`GCP_SA_KEY`（必須一模一樣，workflow 會用這個名稱）。
   - **Secret**：用文字編輯器開啟步驟二下載的 JSON 檔案，**全選、複製整份內容**，貼到這個欄位（不要只貼路徑，要貼完整 JSON）。
6. 點 **Add secret**。

完成後在 Actions secrets 裡會看到 `GCP_SA_KEY`（內容不會顯示）。

---

## 步驟四：確認 workflow 的專案與倉庫名稱

目前 workflow 使用：

- 專案：`milestone1-tzuyu`
- 區域：`us-central1`
- 倉庫名稱：`docker`

若你在步驟一用了**不同的倉庫名稱**或**不同區域**，請編輯專案根目錄的 `.github/workflows/build.yml`，修改最上方的 `env`：

```yaml
env:
  GCP_PROJECT: milestone1-tzuyu
  GAR_REGION: us-central1    # 改成你的區域，例如 asia-east1
  GAR_REPOSITORY: docker    # 改成你的倉庫名稱
```

存檔後一併 commit 並 push。

---

## 步驟五：推送程式碼並打版本 tag 觸發推送映像

步驟五一共要做 **兩種 push**：

| 順序 | 在做什麼 | 指令 |
|------|----------|------|
| **Push ①** | 把程式碼推到 GitHub 的 `main` 分支 | `git push origin main` |
| **Push ②** | 把版本 tag 推到 GitHub（觸發 CI 建映像並推到 Artifact Registry） | `git push origin v1.0.0` |

---

**具體操作：**

1. **先 commit 並 Push ①（推程式碼到 main）**
   ```bash
   git status
   git add .
   git commit -m "Milestone 2: containerization and CI/CD"
   git push origin main
   ```
   → 這樣 GitHub 上會有最新程式碼；CI 會跑測試與建置，但**不會**把映像推到 Artifact Registry。

2. **再打 tag 並 Push ②（推 tag，才會推映像）**
   ```bash
   git tag v1.0.0
   git push origin v1.0.0
   ```
   → 推送 **tag** 後，workflow 才會把映像 push 到 GCP Artifact Registry。

3. 到 GitHub 倉庫 **Actions** 分頁，應會看到 **Build and Push ML Service** workflow 執行；等 **Test** 與 **Build and Push** 都變綠色即成功。
4. 到 GCP **Artifact Registry** → 選你的 `docker` 倉庫，應會看到映像 **ml-service**，tag 為 **v1.0.0**。

映像完整名稱範例：  
`us-central1-docker.pkg.dev/milestone1-tzuyu/docker/ml-service:v1.0.0`

---

## 步驟六：繳交用截圖（Registry verification）

依作業要求需證明「成功 push 且 tag 正確」：

1. 在 GCP 開啟 **Artifact Registry** → 點進你的 Docker 倉庫。
2. 點進 **ml-service** 映像，確認有 tag（例如 **v1.0.0**）。
3. 截圖畫面（需能看到專案名稱、倉庫名稱、映像名稱與 tag），或複製映像網址，作為「Registry verification」繳交。

---

## 檢查清單（設定是否完成）

- [ ] GCP 專案 **milestone1-tzuyu** 中已建立 **Docker 格式**的 Artifact Registry 倉庫（名稱/區域與 workflow 一致）。
- [ ] 服務帳戶 **artifact-registry-push** 具備 **Artifact Registry Writer**（你畫面上已顯示，無需再改）。
- [ ] 已為 **artifact-registry-push** 建立 **JSON 金鑰**並下載。
- [ ] GitHub 倉庫 **Settings → Secrets and variables → Actions** 中已新增 **GCP_SA_KEY**，內容為整份 JSON 金鑰。
- [ ] 已 push 程式碼並執行過 `git tag v1.0.0` 與 `git push origin v1.0.0`。
- [ ] GitHub Actions 中 **Build and Push ML Service** 已成功跑完，且 GCP Artifact Registry 中能看到 **ml-service:v1.0.0**。

---

## 常見問題

| 狀況 | 處理方式 |
|------|----------|
| Push 時 CI 報錯「unauthorized」或「permission denied」 | 檢查 GitHub Secret 名稱是否為 `GCP_SA_KEY`，且貼的是**整份** JSON（從 `{` 到 `}`），沒有少字或多餘空格。 |
| 找不到 Artifact Registry 倉庫 | 確認 GCP 專案與區域正確；workflow 的 `GAR_REGION`、`GAR_REPOSITORY` 要與 Console 中建立的倉庫一致。 |
| 只有 Test 通過，沒有 Push | 映像**只會在推送 version tag 時**推送（例如 `v1.0.0`）。只 push 到 `main` 會建置但不會 push 到 GAR。請執行 `git tag v1.0.0` 再 `git push origin v1.0.0`。 |
| 想改用其他區域或倉庫名稱 | 在 `.github/workflows/build.yml` 的 `env` 中修改 `GAR_REGION` 與 `GAR_REPOSITORY`，並在 GCP 建立對應的倉庫。 |

更多技術細節與除錯可參考同目錄的 **RUNBOOK.md**。
